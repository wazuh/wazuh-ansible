---
- name: Include Repository Variables
  ansible.builtin.include_vars: ../../vars/repo_vars.yml

- name: Include Production Repository Variables
  ansible.builtin.include_vars: ../../vars/repo.yml
  when: packages_repository == 'production'

- name: Include Pre-Release Repository Variables
  ansible.builtin.include_vars: ../../vars/repo_pre-release.yml
  when: packages_repository == 'pre-release'

- name: Include Staging Repository Variables
  ansible.builtin.include_vars: ../../vars/repo_staging.yml
  when: packages_repository == 'staging'

- name: Red Hat/Centos | Install Wazuh Dashboard
  ansible.builtin.import_tasks: RedHat.yml
  when: ansible_os_family == 'RedHat'

- name: Debian/Ubuntu | Install Wazuh Dashboard
  ansible.builtin.import_tasks: Debian.yml
  when: ansible_os_family == 'Debian'

- name: Remove Dashboard configuration file
  ansible.builtin.file:
    path: "{{ wazuh_dashboard_conf_path }}/opensearch_dashboards.yml"
    state: absent
  tags: install

- name: Run Security Actions
  ansible.builtin.import_tasks: security_actions.yml

- name: Copy Configuration File
  ansible.builtin.template:
    src: "templates/opensearch_dashboards.yml.j2"
    dest: "{{ wazuh_dashboard_conf_path }}/opensearch_dashboards.yml"
    group: wazuh-dashboard
    owner: wazuh-dashboard
    mode: "0640"
    force: true
  notify: Restart wazuh-dashboard
  tags:
    - install
    - configure

- name: Ensuring Wazuh dashboard directory owner
  ansible.builtin.file:
    path: "/usr/share/wazuh-dashboard"
    state: directory
    owner: wazuh-dashboard
    group: wazuh-dashboard
    recurse: true

- name: Wait for Wazuh-Indexer port
  ansible.builtin.wait_for:
    host: "{{ wazuh_indexer_network_host }}"
    port: "{{ wazuh_indexer_http_port }}"

- name: Select correct API protocol
  ansible.builtin.set_fact:
    wazuh_indexer_api_protocol: "{% if wazuh_dashboard_security is defined and wazuh_dashboard_security %}https{% else %}http{% endif %}"

- name: Attempting to delete legacy Wazuh index if exists
  ansible.builtin.uri:
    url: "{{ wazuh_indexer_api_protocol }}://{{ wazuh_indexer_network_host }}:{{ wazuh_indexer_http_port }}/.wazuh"
    method: DELETE
    user: "admin"
    password: "{{ wazuh_indexer_admin_password }}"
    validate_certs: false
    status_code: 200, 404

- name: Create Wazuh Plugin config directory
  ansible.builtin.file:
    path: /usr/share/wazuh-dashboard/data/wazuh/config/
    state: directory
    recurse: true
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: "0751"
  changed_when: false

- name: Configure Wazuh Dashboard Plugin
  ansible.builtin.template:
    src: wazuh.yml.j2
    dest: /usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: "0751"
  changed_when: false

- name: Configure opensearch.password in opensearch_dashboards.keystore
  ansible.builtin.shell: |
    set -o pipefail
    echo '{{ wazuh_dashboard_password }}' | /usr/share/wazuh-dashboard/bin/opensearch-dashboards-keystore --allow-root add -f --stdin opensearch.password
  args:
    executable: /bin/bash
  changed_when: false
  become: true

- name: Ensure Wazuh dashboard started and enabled
  ansible.builtin.service:
    name: wazuh-dashboard
    enabled: true
    state: started

- name: Remove Red Hat repository
  ansible.builtin.import_tasks: RMRedHat.yml
  when: ansible_os_family == 'RedHat'
