---
# Wazuh Agent - Linux Tasks

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true
  when: ansible_os_family == 'Debian'

- name: Import Wazuh GPG key (Debian/Ubuntu)
  ansible.builtin.apt_key:
    url: "{{ wazuh_repo_gpg_key }}"
    state: present
  become: true
  when: ansible_os_family == 'Debian'

- name: Add Wazuh repository (Debian/Ubuntu)
  ansible.builtin.apt_repository:
    repo: "deb {{ wazuh_repo_url_apt }} stable main"
    state: present
    filename: wazuh
    update_cache: true
  become: true
  when: ansible_os_family == 'Debian'

- name: Import Wazuh GPG key (RHEL/CentOS)
  ansible.builtin.rpm_key:
    key: "{{ wazuh_repo_gpg_key }}"
    state: present
  become: true
  when: ansible_os_family == 'RedHat'

- name: Add Wazuh repository (RHEL/CentOS)
  ansible.builtin.yum_repository:
    name: wazuh
    description: Wazuh repository
    baseurl: "{{ wazuh_repo_url_yum }}"
    gpgcheck: true
    gpgkey: "{{ wazuh_repo_gpg_key }}"
    enabled: true
  become: true
  when: ansible_os_family == 'RedHat'

- name: Set Wazuh Manager address for agent enrollment
  ansible.builtin.set_fact:
    wazuh_manager_address: "{{ wazuh_agent_registration_address | default(wazuh_manager_nodes[0].ip) }}"

- name: Install Wazuh Agent (Debian/Ubuntu)
  ansible.builtin.apt:
    name: "wazuh-agent={{ wazuh_version }}-*"
    state: present
    update_cache: true
  become: true
  environment:
    WAZUH_MANAGER: "{{ wazuh_manager_address }}"
  when: ansible_os_family == 'Debian'
  notify: restart wazuh-agent

- name: Install Wazuh Agent (RHEL/CentOS)
  ansible.builtin.dnf:
    name: "wazuh-agent-{{ wazuh_version }}"
    state: present
  become: true
  environment:
    WAZUH_MANAGER: "{{ wazuh_manager_address }}"
  when: ansible_os_family == 'RedHat'
  notify: restart wazuh-agent

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Configure Wazuh Agent
  ansible.builtin.template:
    src: ossec.conf.j2
    dest: "{{ wazuh_agent_config_path }}"
    owner: root
    group: wazuh
    mode: '0640'
    backup: true
  become: true
  notify: restart wazuh-agent

- name: Start and enable Wazuh Agent service
  ansible.builtin.service:
    name: "{{ wazuh_agent_service_name }}"
    state: started
    enabled: true
  become: true

- name: Wait for agent to connect to manager
  ansible.builtin.wait_for:
    path: /var/ossec/var/run/wazuh-agentd.state
    state: present
    timeout: 120
  become: true
  ignore_errors: true
