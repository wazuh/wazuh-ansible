---

- name: Check if local_configs_path directory exists
  delegate_to: localhost
  become: false
  run_once: true
  block:
    - name: Retrieve local_configs_path directory information
      ansible.builtin.stat:
        path: "{{ local_configs_path }}"
      register: local_configs_path_stat

    - name: Fail if directory does not exist
      ansible.builtin.fail:
        msg: "The directory {{ local_configs_path }} (local_configs_path) does not exist."
      when: not local_configs_path_stat.stat.exists

- name: Ensure wazuh-dashboard package download directory exists
  ansible.builtin.file:
    path: "{{ wazuh_dashboard_package_download_path }}"
    state: directory
    mode: '0755'

- name: RHEL, CentOS, and Amazon Linux 2 | Configure system settings and install dependencies
  when: ansible_facts.os_family == 'RedHat'
  block:
    - name: RedHat/CentOS/Fedora | Install Dashboard dependencies
      ansible.builtin.dnf:
        name: "{{ packages }}"
        state: present
        update_cache: true
      vars:
        packages:
          - libcap

    - name: RedHat/CentOS/Fedora (x86_64) | Download wazuh-dashboard package
      ansible.builtin.get_url:
        url: "{{ wazuh_dashboard_amd64_rpm }}"
        dest: "{{ wazuh_dashboard_package_download_path }}/{{ wazuh_dashboard_package_name }}_{{ ansible_facts.architecture }}.rpm"
        mode: '0644'
      when:
        - ansible_facts.architecture == "x86_64"

    - name: RedHat/CentOS/Fedora (aarch64) | Download wazuh-dashboard package
      ansible.builtin.get_url:
        url: "{{ wazuh_dashboard_arm64_rpm }}"
        dest: "{{ wazuh_dashboard_package_download_path }}/{{ wazuh_dashboard_package_name }}_{{ ansible_facts.architecture }}.rpm"
        mode: '0644'
      when:
        - ansible_facts.architecture == "aarch64"

- name: Debian-based systems | Install Wazuh dashboard dependencies and download package
  when: ansible_facts.os_family == 'Debian'
  block:
    - name: Debian-based | Install Dashboard dependencies
      ansible.builtin.apt:
        name:
          - 'debhelper'
          - 'tar'
          - 'curl'
          - 'libcap2-bin'
        update_cache: true
        state: present

    - name: Debian-based | Check if needrestart is available
      ansible.builtin.command: which needrestart
      register: needrestart_check
      failed_when: false
      changed_when: false

    - name: Debian-based | Restart required services after dependencies installation
      when: needrestart_check is defined
      block:
        - name: Debian-based | Get services that need restart
          ansible.builtin.shell: |
            set -o pipefail
            DEBIAN_FRONTEND=noninteractive needrestart -b 2>/dev/null | grep '^NEEDRESTART-SVC:' | awk '{print $2}'
          args:
            executable: /bin/bash
          register: services_to_restart
          changed_when: false
          when: needrestart_check.rc == 0

        - name: Debian-based | Restart required services (except SSH)
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: restarted
          loop: "{{ services_to_restart.stdout_lines | default([]) }}"
          when:
            - needrestart_check.rc == 0
            - services_to_restart.stdout_lines is defined
            - item not in ['ssh.service', 'sshd.service']
          failed_when: false

        - name: Debian-based | Restart SSH service if needed
          ansible.builtin.systemd:
            name: "{{ item }}"
            state: restarted
          loop: "{{ services_to_restart.stdout_lines | default([]) }}"
          when:
            - needrestart_check.rc == 0
            - services_to_restart.stdout_lines is defined
            - item in ['ssh.service', 'sshd.service']
          async: 1
          poll: 0
          failed_when: false

        - name: Debian-based | Wait for SSH connection to be available again
          ansible.builtin.wait_for_connection:
            delay: 30
            timeout: 300
          when:
            - needrestart_check.rc == 0
            - services_to_restart.stdout_lines is defined
            - "'ssh.service' in services_to_restart.stdout_lines or 'sshd.service' in services_to_restart.stdout_lines"

    - name: Debian-based (AMD64) | Download wazuh-dashboard package
      ansible.builtin.get_url:
        url: "{{ wazuh_dashboard_amd64_deb }}"
        dest: "{{ wazuh_dashboard_package_download_path }}/{{ wazuh_dashboard_package_name }}_{{ ansible_facts.architecture }}.deb"
        mode: '0644'
      when:
        - ansible_facts.architecture == "x86_64"

    - name: Debian-based (ARM64) | Download wazuh-dashboard package
      ansible.builtin.get_url:
        url: "{{ wazuh_dashboard_arm64_deb }}"
        dest: "{{ wazuh_dashboard_package_download_path }}/{{ wazuh_dashboard_package_name }}_{{ ansible_facts.architecture }}.deb"
        mode: '0644'
      when:
        - ansible_facts.architecture == "aarch64"
