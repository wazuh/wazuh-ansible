---

- name: Importing variables [vars/main.yml]
  ansible.builtin.include_vars:
    file: ../../vars/main.yml

- name: Importing urls_file variables
  ansible.builtin.include_vars:
    file: ../../vars/{{ urls_file }}

- name: Importing dependencies.yml
  ansible.builtin.import_tasks: dependencies.yml
  become: true

- name: Linux CentOS/RedHat | Install wazuh-dashboard using yum
  ansible.builtin.dnf:
    name: "{{ wazuh_dashboard_package_download_path }}/{{ wazuh_dashboard_package_name }}_{{ ansible_facts.architecture }}.rpm"
    state: present
    disable_gpg_check: true
  become: true
  when:
    - ansible_facts.os_family == "RedHat"

- name: Linux Debian | Install wazuh-dashboard using APT
  ansible.builtin.apt:
    deb: "{{ wazuh_dashboard_package_download_path }}/{{ wazuh_dashboard_package_name }}_{{ ansible_facts.architecture }}.deb"
    state: present
  become: true
  when:
    - ansible_facts.os_family == 'Debian'

- name: Linux | Reload systemd configuration
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Dashboard-config | Configure Wazuh dashboard
  block:
    - name: Dashboard-config | Remove current opensearch.hosts configuration
      ansible.builtin.replace:
        path: /etc/wazuh-dashboard/opensearch_dashboards.yml
        regexp: '^opensearch\.hosts:.*(?:\n\s+-\s+https?://[^\n]+)*'
        replace: 'opensearch.hosts:'

    - name: Dashboard-config | Add opensearch.hosts configuration
      ansible.builtin.replace:
        path: /etc/wazuh-dashboard/opensearch_dashboards.yml
        regexp: '^opensearch\.hosts:\s*$'
        replace: |
          opensearch.hosts:
          {% for node in indexer_cluster_nodes %}
            - https://{{ node }}:9200
          {% endfor %}

    - name: Dashboard-config | Set Wazuh server host URL
      ansible.builtin.replace:
        path: /etc/wazuh-dashboard/opensearch_dashboards.yml
        regexp: '^(\s*)url:\s*https://.*$'
        replace: '\1url: https://{{ wazuh_manager_master_address }}'

- name: Detect expected dashboard SSL certificate names from opensearch_dashboards.yml
  block:
    - name: Read opensearch_dashboards.yml
      ansible.builtin.slurp:
        path: /etc/wazuh-dashboard/opensearch_dashboards.yml
      register: wazuh_dashboard_conf_raw
      changed_when: false

    - name: Extract expected certificate/key
      ansible.builtin.set_fact:
        expected_cert_path: "{{ (certificate_paths | first | default('') | trim) }}"
        expected_key_path: "{{ (key_paths | first | default('') | trim) }}"
      vars:
        conf_text: "{{ wazuh_dashboard_conf_raw.content | b64decode }}"
        certificate_paths: "{{ conf_text | regex_findall('(?m)^\\s*server\\.ssl\\.certificate\\s*:\\s*\"?(/\\S+\\.pem)\"?(?:\\s+#.*)?$') }}"
        key_paths: "{{ conf_text | regex_findall('(?m)^\\s*server\\.ssl\\.key\\s*:\\s*\"?(/\\S+\\.pem)\"?(?:\\s+#.*)?$') }}"

    - name: Validate expected certificate and key filenames
      ansible.builtin.assert:
        that:
          - ( expected_cert_path | length > 0 ) and ( expected_key_path | length > 0 )
          - ( expected_cert_path is match('^/.+\\.pem$') ) and ( expected_key_path is match('^/.+\\.pem$') )
        fail_msg: >-
          Invalid dashboard SSL certificate/key filenames detected from
          /etc/wazuh-dashboard/opensearch_dashboards.yml.
      changed_when: false

    - name: Create expected cert/key directory (if does not exist)
      ansible.builtin.file:
        path: "{{ expected_cert_path | dirname }}"
        state: directory
        owner: wazuh-dashboard
        group: wazuh-dashboard
        mode: "0700"

- name: Copy the certificates from local to the Wazuh dashboard instance
  ansible.builtin.copy:
    src: "{{ local_configs_path }}/wazuh-certificates/{{ item }}"
    dest: "{{ expected_cert_path | dirname }}/{{ item }}"
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: "0400"
  with_items:
    - "root-ca.pem"
    - "{{ dashboard_node_name }}-key.pem"
    - "{{ dashboard_node_name }}.pem"

- name: Copy certificates to match default names
  ansible.builtin.copy:
    src: "{{ expected_cert_path | dirname }}/{{ item.src }}"
    dest: "{{ item.dest }}"
    remote_src: true
    owner: wazuh-dashboard
    group: wazuh-dashboard
    mode: "0400"
  with_items:
    - { src: "{{ dashboard_node_name }}.pem", dest: "{{ expected_cert_path }}" }
    - { src: "{{ dashboard_node_name }}-key.pem", dest: "{{ expected_key_path }}" }
  when: (expected_cert_path | dirname ~ '/' ~ item.src) != item.dest

- name: Reload systemd configuration
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Ensure Wazuh dashboard started
  ansible.builtin.service:
    name: wazuh-dashboard
    enabled: true
    state: restarted

- name: Extract server host from dashboard configuration
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      grep '^server.host:' /etc/wazuh-dashboard/opensearch_dashboards.yml | awk '{print $2}'
    executable: /bin/bash
  register: server_host
  changed_when: false

- name: Extract server port from dashboard configuration
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      grep '^server.port:' /etc/wazuh-dashboard/opensearch_dashboards.yml | awk '{print $2}'
    executable: /bin/bash
  register: server_port
  changed_when: false

- name: Wait for Wazuh dashboard to be ready
  ansible.builtin.uri:
    url: "https://{{ server_host.stdout }}:{{ server_port.stdout }}/app/login"
    method: GET
    status_code: 200
    validate_certs: false
  register: result
  retries: 24
  delay: 5
  until: result.status == 200

- name: Remove installation leftovers
  ansible.builtin.file:
    path: "{{ wazuh_dashboard_package_download_path }}"
    state: absent
    force: true
  become: true
