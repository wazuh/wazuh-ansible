---
# Wazuh Manager Role - Main Tasks

- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
    - "{{ ansible_distribution }}.yml"
    - "{{ ansible_os_family }}.yml"
    - "default.yml"
  ignore_errors: true

- name: Install prerequisites
  ansible.builtin.include_tasks: prerequisites.yml

- name: Configure Wazuh repository
  ansible.builtin.include_tasks: repository.yml

- name: Install Wazuh Manager
  ansible.builtin.include_tasks: install.yml

- name: Configure certificates
  ansible.builtin.include_tasks: certificates.yml
  when: wazuh_generate_certs | default(true)

- name: Configure Wazuh Manager
  ansible.builtin.include_tasks: configure.yml

- name: Configure Wazuh API
  ansible.builtin.include_tasks: api.yml

- name: Configure cluster
  ansible.builtin.include_tasks: cluster.yml
  when: wazuh_manager_cluster_enabled | default(false)

- name: Configure firewall
  ansible.builtin.include_tasks: firewall.yml
  when: wazuh_configure_firewall | default(true)

- name: Start and enable Wazuh Manager service
  ansible.builtin.service:
    name: "{{ wazuh_manager_service_name }}"
    state: started
    enabled: true
  become: true

- name: Wait for Wazuh Manager API to be ready
  ansible.builtin.uri:
    url: "https://{{ ansible_default_ipv4.address }}:{{ wazuh_manager_api_port }}/security/user/authenticate"
    method: POST
    user: "{{ wazuh_api_user }}"
    password: "{{ wazuh_api_password }}"
    force_basic_auth: true
    validate_certs: false
    status_code: [200, 401]
  register: wazuh_api_check
  until: wazuh_api_check.status in [200, 401]
  retries: 30
  delay: 10
  when: manager_node_type | default('master') == 'master'
