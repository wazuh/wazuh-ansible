---

- name: Gather Wazuh Central Logs
  hosts: all
  # strategy: free
  become: true
  tasks:
    - name: Make sure local_log_file_path directory exists on local machine
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: "{{ local_log_file_path }}"
        state: directory
        mode: '0755'

    - name: Set required facts for logs gathering (1/2)
      ansible.builtin.set_fact:
        logs_prefix: "{{ ansible_facts.distribution }}_{{ ansible_facts.distribution_major_version }}_{{ ansible_facts.architecture }}_{{ inventory_hostname }}"

    - name: Set required facts for logs gathering (2/2)
      ansible.builtin.set_fact:
        remote_gathering_path: "/tmp/wazuh_logs_{{ logs_prefix }}_{{ ansible_date_time.epoch }}"

    - name: Remove existing Wazuh logs temporal directories
      ansible.builtin.file:
        path: "{{ remote_gathering_path }}"
        state: absent

    - name: Set fact for logs directory
      ansible.builtin.set_fact:
        remote_logs_path: "{{ remote_gathering_path }}/logs"

    - name: Create temporal directories for Wazuh logs
      ansible.builtin.file:
        path: "{{ remote_logs_path }}/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - wazuh-indexer
        - wazuh-manager
        - wazuh-dashboard

    - name: Make sure local_log_file_path directory exists on local machine
      delegate_to: localhost
      become: false
      ansible.builtin.file:
        path: "{{ local_log_file_path }}/compressed_individual_logs"
        state: directory
        mode: '0755'

    - name: Wazuh Indexer
      when: (single_node | bool) or inventory_hostname in groups['wi_cluster']
      ignore_errors: true
      block:
        - name: Wazuh Indexer | Fetching logs (1/3)
          changed_when: false
          ansible.builtin.shell: |
            journalctl -u wazuh-indexer > {{ remote_logs_path }}/wazuh-indexer/{{ logs_prefix }}_journalctl.log

        - name: Wazuh Indexer | Fetching logs (2/3)
          ansible.builtin.find:
            paths: /var/log/wazuh-indexer
            file_type: file
          register: wi_indexer_logs

        - name: Wazuh Indexer | Fetching logs (3/3)
          ansible.builtin.copy:
            src: "{{ item.path }}"
            dest: "{{ remote_logs_path }}/wazuh-indexer/{{ logs_prefix }}_{{ item.path | basename }}"
            mode: '0644'
            remote_src: true
          loop: "{{ wi_indexer_logs.files | default([]) }}"
          loop_control:
            label: "{{ item.path | basename }}"
          when: wi_indexer_logs is defined and (wi_indexer_logs.matched | int) > 0

        - name: Wazuh Indexer | Fetching configuration
          ansible.builtin.copy:
            src: /etc/wazuh-indexer/opensearch.yml
            dest: "{{ remote_logs_path }}/wazuh-indexer/{{ logs_prefix }}_opensearch.yml"
            mode: '0644'
            remote_src: true

    - name: Wazuh Manager
      when: (single_node | bool) or inventory_hostname in ['manager', 'worker']
      ignore_errors: true
      block:
        - name: Wazuh Manager | Fetching logs (1/3)
          changed_when: false
          ansible.builtin.shell: |
            journalctl -u wazuh-manager > {{ remote_logs_path }}/wazuh-manager/{{ logs_prefix }}_journalctl.log

        - name: Wazuh Manager | Fetching logs (2/3)
          ansible.builtin.find:
            paths: /var/wazuh-manager/logs/
            file_type: file
          register: wazuh_manager_logs

        - name: Wazuh Manager | Fetching logs (3/3)
          ansible.builtin.copy:
            src: "{{ item.path }}"
            dest: "{{ remote_logs_path }}/wazuh-manager/{{ logs_prefix }}_{{ item.path | basename }}"
            remote_src: true
            mode: '0644'
          loop: "{{ wazuh_manager_logs.files | default([]) }}"
          loop_control:
            label: "{{ item.path | basename }}"
          when: wazuh_manager_logs is defined and (wazuh_manager_logs.matched | int) > 0

        - name: Wazuh Manager | Fetching configuration
          ansible.builtin.copy:
            src: /var/wazuh-manager/etc/wazuh-manager.conf
            dest: "{{ remote_logs_path }}/wazuh-manager/{{ logs_prefix }}_wazuh-manager.conf"
            remote_src: true
            mode: '0644'

    - name: Wazuh Dashboard
      ignore_errors: true
      when: (single_node | bool) or inventory_hostname in ['dashboard']
      block:
        - name: Wazuh Dashboard | Fetching logs
          changed_when: false
          ansible.builtin.shell: |
            journalctl -u wazuh-dashboard > {{ remote_logs_path }}/wazuh-dashboard/{{ logs_prefix }}_journalctl.log

        - name: Wazuh Dashboard | Fetching configuration
          ansible.builtin.copy:
            src: /etc/wazuh-dashboard/opensearch_dashboards.yml
            dest: "{{ remote_logs_path }}/wazuh-dashboard/{{ logs_prefix }}_opensearch_dashboards.yml"
            remote_src: true
            mode: '0644'

    - name: Compress Wazuh logs
      block:
        - name: Compress Wazuh logs (archive module)
          community.general.archive:
            path: "{{ remote_logs_path }}/*"
            dest: "{{ remote_gathering_path }}/compressed_wazuh_logs_{{ logs_prefix }}.tar.gz"
            format: gz
            mode: '0644'
      rescue:
        - name: Compress Wazuh logs (tar command) # noqa: command-instead-of-module
          ansible.builtin.shell: |
            tar -czf {{ remote_gathering_path }}/compressed_wazuh_logs_{{ logs_prefix }}.tar.gz -C {{ remote_logs_path }} .
          args:
            creates: "{{ remote_gathering_path }}/compressed_wazuh_logs_{{ logs_prefix }}.tar.gz"

    - name: Copy Wazuh logs to local machine
      ansible.builtin.fetch:
        src: "{{ remote_gathering_path }}/compressed_wazuh_logs_{{ logs_prefix }}.tar.gz"
        dest: "{{ local_log_file_path }}/compressed_individual_logs/"
        flat: true

    - name: Remove Wazuh logs temporal directory from remote machine
      ansible.builtin.file:
        path: "{{ remote_gathering_path }}"
        state: absent

    - name: Local actions
      delegate_to: localhost
      become: false
      run_once: true
      when: not (single_node | bool)
      block:
        - name: Create central_logs_organized directory on local machine
          ansible.builtin.file:
            path: "{{ local_log_file_path }}/central_logs_organized"
            state: directory
            mode: '0755'

        - name: Find compressed Wazuh logs archives on local machine
          ansible.builtin.find:
            paths: "{{ local_log_file_path }}/compressed_individual_logs"
            patterns: "compressed_wazuh_logs_*.tar.gz"
            file_type: file
          register: local_wazuh_archives

        - name: Unpack Wazuh logs archives into central_logs_organized directory
          ansible.builtin.unarchive:
            src: "{{ item.path }}"
            dest: "{{ local_log_file_path }}/central_logs_organized"
            remote_src: false
          loop: "{{ local_wazuh_archives.files | default([]) }}"
          loop_control:
            label: "{{ item.path | basename }}"
          when: local_wazuh_archives is defined and (local_wazuh_archives.matched | int) > 0

        - name: Remove temporal compressed_individual_logs local directory
          ansible.builtin.file:
            path: "{{ local_log_file_path }}/compressed_individual_logs"
            state: absent
